<?xml version="1.0"?>
<!DOCTYPE dynamideForm>
<!-- Copyright (c) 2001, 2002 DYNAMIDE.COM -->

<dynamideForm>

<properties>
    <property name="type"><value>pagetypes/com.dynamide.form</value></property>
    <property name="bgcolor"><value>#A4BFDD</value></property>
</properties>

<htmlsrc><![CDATA[
  <html>
    <HEAD>
        <title>Properties</title>
        $session.getInclude("resources/css/ide.css")
        $session.getInclude("resources/js/scripts.js")
        $session.getInclude("resources/js/windowing.js")
    </HEAD>
    <body topmargin='0' leftmargin='4'  marginwidth="4" marginheight="4" bgColor="$page.bgcolor">

    <form name="mojoForm" action="/dynamide/ide">
      <b>Page ID:</b> <SPAN class="widget" id="pagelist1"/>
      <div class="widget" id="propertytable1" />
      <span class="widget" id="submitProperties" />
      <SPAN class="widget" id="hiddenPageID"/>
      <SPAN class="widget" id="session1"/>
      <SPAN class="widget" id="subsession1"/>
      #set $targetPageIDParam =  $session.getQueryParam("targetPageID")
      <!--INPUT type="hidden" name="targetPageID" value="$targetPageIDParam" /-->
    </form>
    </body>
  </html>
]]></htmlsrc>

<widgets>
   <widget id="propertytable1"  >
     <properties>
        <property name="type"><value>com.dynamide.ide.propertytable</value></property>
        <property name="name"><value>propertytable1</value></property>
        <property name="value"><value>thevalue</value></property>
     </properties>
   </widget>

   <widget id="submitProperties"  >
     <properties>
        <property name="type"><value>com.dynamide.submit</value></property>
        <property name="name"><value>submitProperties</value></property>
     </properties>
   </widget>
    <widget id="hiddenPageID">
      <properties>
        <property name="field">
          <value>page</value>
        </property>
        <property name="type">
          <value>com.dynamide.hidden</value>
        </property>
        <property name="value">
          <datatype>com.dynamide.datatypes.WebmacroDatatype</datatype>
          <value>$pageID</value>
        </property>
      </properties>
    </widget>
    <widget id="session1">
      <properties>
        <property name="type">
          <value>com.dynamide.session</value>
        </property>
      </properties>
    </widget>
    <widget id="subsession1">
      <properties>
        <property name="field">
          <value>SUBSESSIONID</value>
        </property>
        <property name="type">
          <value>com.dynamide.hidden</value>
        </property>
       </properties>
    </widget>
    <widget id="pagelist1">
      <properties>
        <property name="type">
          <value>com.dynamide.ide.pagelist</value>
        </property>
	<property name="selectName">
          <value>targetPageID</value>
        </property>
	<property name="dropdown"><value>true</value></property>
	<property name="caption"><value></value></property>
	<property name="useSUBSESSIONID"><value>true</value></property>
        
       </properties>
    </widget>


</widgets>

<event language="beanshell" name="properties_onAction">
  <![CDATA[
    System.out.println("in properties_onAction: "+event.action);
    //URL[] urls = getClassPath();
    //for (int i = 0; i < urls.length; i++){
    //    event.println("beanshell classpath: "+urls[i]);
    //}

    if (event.action.equals("getData")){
         try {
            print("======================================event.action was getData");
            request = event.session.getRequest();
            String propertyValue = "oops";
            String propertyName = event.getQueryParam("propertyName");
            propertyValue = event.getQueryParam("propertyValue");
            String widgetID = event.getQueryParam("widgetID");
            String targetPageID = event.getQueryParam("targetPageID");
            String subsessionID = event.session.getFieldValue("SUBSESSIONID");
            String noPropUpdate = event.getQueryParam("noPropUpdate");

            Session subsession = event.session.findSession(subsessionID);
            boolean debug = true;
            //print("----- properties_onAction ----- "+widgetID +" prop: "+propertyName+" val: "+propertyValue);
            if (subsession == null){
                event.resultSrc = "ERROR: subsession is null "+subsessionID;
            } else {
                Page targetPage = subsession.getPageByID(targetPageID);
                String emsg;
                if (targetPageID.equals(widgetID)){
                    if (targetPage == null){
                        emsg = "ERROR: targetPageID (page as widget) was not found: "+targetPageID;
                        event.resultSrc = "<html><body>"
                                        +emsg
                                        +"</body></html>";
                        event.println("(1) event message is: "+emsg);
                    } else {
                        //A page property was changed, and we know this because targetPageID and widgetID are both the page ID
                        // (but not pageID, since that is this page's ID).
                        emsg = targetPage.getPagePropertyEval(propertyName, propertyValue, request);
                        event.resultSrc = "<html><body>"
                                        +emsg
                                        +"</body></html>";
                        if (debug) event.println("(2) event message is: "+emsg);
                    }
                } else {
                    if (targetPage == null){
                        emsg = "ERROR: targetPageID was not found: "+targetPageID;
                        event.resultSrc = "<html><body>"
                                        +emsg
                                        +"</body></html>";
                        event.println(emsg);
                    } else {
                        Widget widget = targetPage.getWidgetByID(widgetID);
                        if (widget != null){
                            if ( ! Tools.isTrue(noPropUpdate)){ //empty string results in false.
                                widget.changeProperty(propertyName, propertyValue);
                            }
                            emsg = targetPage.getWidgetDiv(widgetID, request);
                        } else {
                            emsg = "ERROR: widget '"+widgetID+"' not found on page '"+targetPageID+"'";
                        }
                        event.resultSrc = "<html><body>"
                                        +emsg
                                        +"</body></html>";
                        if (debug) event.println("(3) event message is: "+emsg);
                    }
                }
            }
         } catch (Throwable t)  {
            session.logError("Caught Exception in properties_onAction action: "+event.action, t);
            event.resultSrc = "<html><body>ERROR: Exception caught getting data for property. See Session log</body></html>";
         }
         event.println("[getData] event:: "+StringTools.escape(event.toString()));
         event.println("event.resultSrc preview:: "+event.resultSrc);
         event.resultAction = ScriptEvent.RA_RETURN_SOURCE;
    } else if (event.action.equals("showInspector")){
        //show properties page,  but first check if widget was clicked.
        //event.println(" event.action is showInspector in inspector.xml");
    }
  ]]>
</event>


</dynamideForm>