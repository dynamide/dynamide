<?xml version="1.0"?>
<!DOCTYPE dynamideForm  >
<!-- Copyright (c) 2001, 2002 DYNAMIDE.COM -->

<dynamideForm>

<properties>
    <property name="type">
        <value>pagetypes/com.dynamide.form</value>
    </property>
</properties>

<htmlsrc><![CDATA[
  <html>
    <head>
        $session.getInclude("resources/js/scripts.js")
        $session.getInclude("resources/js/windowing.js")
    </head>
    <body>
        <form name="frmSaveContents" METHOD="post" ACTION="/dynamide/ide">
        <textarea name="htmlSource">NADA</textarea>
        <input type="hidden" name="SESSIONID" value="$SESSIONID"/>
        <input type="hidden" name="next" value="idehidden"/>
        <input type="hidden" name="page" value="idehidden"/>
        <input type="hidden" name="targetPageID" value=""/>
        <input type="hidden" name="action" value="SaveLayoutView"/>
        </form>
    </body>
  </html>
]]></htmlsrc>

<event language="beanshell" name="idehidden_onAction">
  <![CDATA[
    if (event.action.equals("SaveLayoutView")){
        request = event.session.getRequest();
        String pagepost = event.getQueryParam("htmlSource");
        String subsessionID = event.session.getFieldValue("SUBSESSIONID");
        Session subsession = event.session.findSession(subsessionID);
        String targetPageID = event.getQueryParam("targetPageID");
        
        if (subsession == null){
            event.println("subsession was null");
        } else {
            Page targetPage = subsession.getPageByID(targetPageID);
            if (targetPage != null){
                try {
                    targetPage.setHTMLSource(pagepost);                //throws XMLFormatException
                    if (targetPage.saveToFile()){                      //This flushes the whole XML in-memory tree to disk.
                        event.println("Page "+targetPageID+" saved");
                    } else {
                        event.println("ERROR: couldn't save page "+targetPageID);
                    }
                } catch (XMLFormatException xmle){
                    event.println(xmle.getMessage());
                    return; 
                }
            }
        }
        return;
    }
  ]]>
</event>

</dynamideForm>