<?xml version="1.0"?>
<!DOCTYPE dynamideForm  >
<!-- Copyright (c) 2001, 2002 DYNAMIDE.COM -->

<dynamideForm>

<properties>
    <property name="type">
        <value>pagetypes/com.dynamide.form</value>
    </property>
    <property name="onloadsrc">
        <value></value>
    </property>
</properties>

<htmlsrc><![CDATA[
  <html>
    <head>
        $session.getInclude("resources/js/scripts.js")
        $session.getInclude("resources/js/windowing.js")
        <script language='javascript'>
        <!--
        function showConsoleLog(){
            var  msg = "ERROR: see <a href=\\"javascript:window.open('/dynamide?showSessionConsoleLog=1&SESSIONID=$SESSIONID');window.close();\\">Console Log</a>";
            messageBox('Save Page', msg);
        }
        //-->
        </script>
    </head>
    <body onload="$page.onloadsrc">
        <form name="frmSaveContents" METHOD="post" ACTION="/dynamide/ide">
        <textarea name="htmlSource">NADA</textarea>
        <input type="hidden" name="SESSIONID" value="$SESSIONID"/>
        <input type="hidden" name="next" value="idehidden"/>
        <input type="hidden" name="page" value="idehidden"/>
        <input type="hidden" name="targetPageID" value=""/>
        <input type="hidden" name="action" value="SaveLayoutView"/>
        </form>
    </body>
  </html>
]]></htmlsrc>

<event language="beanshell" name="idehidden_onAction">
  <![CDATA[
    event.currentPage.setProperty("onloadsrc", "");
    event.println("page idehidden in onAction");
    if (event.action.equals("SaveLayoutView")){
        request = event.session.getRequest();
        String pagepost = event.getQueryParam("htmlSource");
        //very verbose: event.println("POSTED Page: \r\n"+pagepost);
        String subsessionID = event.session.getFieldValue("SUBSESSIONID");
        event.println("subsessionID: "+subsessionID);
        Session subsession = event.session.findSession(subsessionID);
        String targetPageID = event.getQueryParam("targetPageID");
        event.println("targetPageID: "+targetPageID);
        String body = "";
        if (subsession == null){
            body = "subsession was null";
            event.println(body);
        } else {
            event.println("subsession was OK");
            body = "targetPage is null";
            Page targetPage = subsession.getPageByID(targetPageID);
            if (targetPage != null){
                body = "got targetPage";
                event.println(body);
                try {
                    //set this to a local dir for debugging: FileTools.saveFile("C:/java", "pagepost.html", pagepost);
                    //debugging: event.println("SEE: C:/java/pagepost.html for source from browser");
                    //6/1/2002 2:56PMtargetPage.setHTMLSourceIE(pagepost); //throws XMLFormatException
                    targetPage.setHTMLSource(pagepost); //throws XMLFormatException
                    boolean result = targetPage.saveToFile(); //This flushes the whole XML in-memory tree to disk.
                    if (result){
                        body = "Page "+targetPageID+" saved";
                        event.println(body);
                    } else {
                        body = "ERROR: couldn't save page "+targetPageID;
                        event.println(body);
                    }
                } catch (XMLFormatException xmle){
                    body = xmle.getMessage();
                    event.println(body);
                    event.currentPage.setProperty("onloadsrc", "javascript:showConsoleLog();");
                    return; // override the result.
                }
            }
        }
        event.currentPage.setProperty("onloadsrc", "javascript:alert('"+body+"');");
        return;
    }
  ]]>
</event>

</dynamideForm>