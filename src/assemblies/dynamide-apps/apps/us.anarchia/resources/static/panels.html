<html>
<head>
    <script src="js/handlebars-v3.0.0.js"></script>
    <script src="js/jquery-2.1.3.min.js"></script>
    <link  href="js/jquery-ui/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
    <script src="js/jquery-ui/ui/minified/jquery-ui.min.js"></script>
    <script src="js/jquery-ui-touch-punch.js"></script>
    <script src="/anarchia/js/anarchia.js"></script>
    <link  href="css/anarchia.css" rel="stylesheet" type="text/css"/>
    
    <style type="">
    body {
        background-color: black;   
        color: black;
    }
    .storyTitle{
        padding: 2px;
        background-color: white;
        font-weight: bold;
        font-size: 130%;
    }
    .storyAuthor{
        padding: 2px;
        background-color: white;
        font-weight: bold;
        font-size: 110%;
    }
    .storyHeader{
        background-color: white;
        padding: 4px;
        color: black;
    }
    
    </style>
</head>
<body>

<div class='storyHeader'>
<span class="storyTitle" id='storyTitle'></span> by <span class="storyAuthor" id='storyAuthor'></span>
</div>
<span class='menu-buttons'>
<a id="prev" class="anarchiaButton" href="javascript:previousPanel();">Previous</a>
<a id="panelIndex"></id>
<a id="next" class="anarchiaButton" href="javascript:nextPanel();">Next</a>
</span>

<div id='panelDiv'>panel here</div>

<script id="TemplateSource" type="text/x-handlebars-template">
    <div class="panel">
    <table width="100%">
    <tr>
    <td colspan="2" class="panel-title">{{text.title}}</td>
    </tr>
    <tr>
    <td></td>
    <td style="text-align: right"><b class='author'>{{author}}</b></td>
    </tr>
    </table>
    <img src="{{img}}" width="400"/><br />
    <div class="caption">{{{text.caption}}}</div>
    <div class="panel-links">{{sequence}} 
        <a href="{{img}}">file</a>
        <a href="javascript:navToEditPanel('{{id}}')">edit panel</a>
        <a href="javascript:navToReorderStory('{{id}}')">reorder story</a>
    </div>
    </div>
</script>

<span class='menu-buttons'>
<a class="anarchiaButton" href='/anarchia/stories.html'>Stories</a>
<a class="anarchiaButton" href='/anarchia-admin/files.html'>Files</a>
<a class="anarchiaButton" href='/anarchia/api.html'>API</a>
</span>

</body>
<script>
    var queryParams = getQueryParams();  //anarchia.js
    var userStoryID = queryParams['storyID'];
    
    var gPanels = null;
    var gPanelIndex = -1;
    var source = document.getElementById('TemplateSource').innerHTML
    var templateFn = Handlebars.compile(source);
        
    function getUserStory(){
        getByStory(userStoryID);
    }
    
    function navToEditPanel(panelID){
        document.location="/anarchia-admin/editPanel.html?panelID="+panelID+"&storyID="+userStoryID;
    }
    
    function navToReorderStory(storyID){
        document.location="/anarchia-admin/reorderStory.html?storyID="+userStoryID;
    }
    
    http://localhost:18080/anarchia-admin/reorderStory.html?storyID=e82eb822-99e7-40d1-8cbd-188b30720592#
    
    function nextPanel(){
        if (gPanels){
            if (gPanels[gPanelIndex+1]){
                gPanelIndex++;
                renderTemplate(gPanels[gPanelIndex]);
            }
        }
    }
    function previousPanel(){
        if (gPanels){
            if (gPanels[gPanelIndex-1]){
                gPanelIndex--;
                renderTemplate(gPanels[gPanelIndex]);
            }
        }
    }
    function disableLink(link){
        link.attr("data-oldhref", link.attr("href"));
        $(link).removeAttr("href");
        link.attr("data-oldcolor", link.css("color"));
        link.css("color", "gray");
    }
    
     function enableLink(link){
        link.attr("href", link.attr("data-oldhref"));
        link.css("color", link.attr("data-oldcolor"));
    }
    
    function renderTemplate(data){
        if (data){
            $('#panelDiv').html(templateFn(data));
            var a = gPanelIndex+1, 
                b = gPanels.length;
            $('#panelIndex').html(""+(a)+" of "+b);
            if (a==1){
                if (a==b){
                    disableLink($('#prev'));
                    disableLink($('#next'));
                } else {
                    disableLink($('#prev'));
                    enableLink($('#next'));
                }
            } else if (a==b) {
                enableLink($('#prev'));
                disableLink($('#next'));
            } else {
                enableLink($('#prev'));
                enableLink($('#next'));
            }
        }
    }
    
    function getByStory(storyid){
        // AJAX CALL HERE :
       $.get('/anarchia?qtype=bystory&storyid='+storyid,
          function(data) {
              console.log('getByStory data: '+JSON.stringify(data));
              
              var panelsDict = {};
              data.panels.forEach(function(val, idx, arr){
                   panelsDict[val.id] = val;
              });
              gPanels = [];
              data.story.panels.forEach(function(val, idx, arr){
                  gPanels.push(panelsDict[val]); 
              });
              
              if (gPanels.length && gPanels.length >-1){
                  var imgs = [];
                  for (var i=0; i<gPanels.length; i++) {
                    imgs.push(gPanels[i].img); 
                  }
                  preloadPictures(imgs);
                  gPanelIndex = 0;
                  renderTemplate(gPanels[0]);
                  $('#storyTitle').html(data.story.title);
                  $('#storyAuthor').html(data.story.author);
                  console.log('panels: '+JSON.stringify(gPanels));
              }
          }
       );
    }
    
    function documentReady(){
        if (userStoryID && userStoryID != ''){
            getByStory(userStoryID);
         } else {
            getByStory('http://anarchia.us/id/stories/1');  //this will be the default story, whatever that is.
         }
    }

    $(document).ready(documentReady);
    
    
var preloadPictures = function(pictureUrls, callback) {
    var i,
        j,
        loaded = 0;

    for (i = 0, j = pictureUrls.length; i < j; i++) {
        (function (img, src) {
            img.onload = function () {                               
                if (++loaded == pictureUrls.length && callback) {
                    callback();
                }
            };

            // Use the following callback methods to debug
            // in case of an unexpected behavior.
            img.onerror = function () {};
            img.onabort = function () {};

            img.src = src;
        } (new Image(), pictureUrls[i]));
    }
};


</script>
</html>

