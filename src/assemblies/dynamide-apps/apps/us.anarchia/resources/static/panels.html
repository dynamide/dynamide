<html>
<head>
    <script src="js/handlebars-v3.0.0.js"></script>
    <script src="js/jquery-2.1.3.min.js"></script>
    <link  href="js/jquery-ui/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
    <script src="js/jquery-ui/ui/minified/jquery-ui.min.js"></script>
    <script src="js/jquery-ui-touch-punch.js"></script>
    <script src="/anarchia/js/anarchia.js"></script>
    <link  href="css/anarchia.css" rel="stylesheet" type="text/css"/>
    
    <style type="">
    body {
        background-color: black;   
        color: black;
    }
    </style>
</head>
<body>

<span class='menu-buttons'>
<a id="prev" class="anarchiaButton" href="javascript:previousPanel();">Previous</a>
<a id="panelIndex"></id>
<a id="next" class="anarchiaButton" href="javascript:nextPanel();">Next</a>
</span>

<div id='panelDiv'>panel here</div>

<script id="TemplateSource" type="text/x-handlebars-template">
    <div class="panel">
    <table width="100%">
    <tr>
    <td colspan="2" class="panel-title">{{text.title}}</td>
    </tr>
    <tr>
    <td></td>
    <td style="text-align: right"><b class='author'>{{author}}</b></td>
    </tr>
    </table>
    <img src="{{img}}" width="400"/><br />
    <div class="caption">{{{text.caption}}}</div>
    <div class="panel-links">{{sequence}} <a href="javascript:alert('ID: {{id}}');">id</a> <a href="javascript:alert('ID: {{_id.$oid}}');">_id</a> <a href="{{img}}">link</a></div>
    </div>
</script>

<span class='menu-buttons'>
<a class="anarchiaButton" href='javascript:getByStory("http://anarchia.us/id/stories/1")'>Story 1</a>
<a class="anarchiaButton" href='javascript:getByStory("http://anarchia.us/id/stories/2")'>Story 2</a>
<a class="anarchiaButton" href='javascript:getByStory("http://anarchia.us/id/stories/3")'>Story 3</a>
<a class="anarchiaButton" href='javascript:getUserStory()'>userStoryID</a>
<a class="anarchiaButton" href='/anarchia/api.html'>API</a>
</span>

</body>
<script>
    var queryParams = getQueryParams();  //anarchia.js
    var userStoryID = queryParams['storyID'];
    
    var gPanels = null;
    var gPanelIndex = -1;
    var source = document.getElementById('TemplateSource').innerHTML
    var templateFn = Handlebars.compile(source);
        
    function getUserStory(){
        getByStory(userStoryID);
    }
    
    function nextPanel(){
        if (gPanels){
            if (gPanels[gPanelIndex+1]){
                gPanelIndex++;
                renderTemplate(gPanels[gPanelIndex]);
            }
        }
    }
    function previousPanel(){
        if (gPanels){
            if (gPanels[gPanelIndex-1]){
                gPanelIndex--;
                renderTemplate(gPanels[gPanelIndex]);
            }
        }
    }
    function disableLink(link){
        link.attr("data-oldhref", link.attr("href"));
        $(link).removeAttr("href");
        link.attr("data-oldcolor", link.css("color"));
        link.css("color", "gray");
    }
    
     function enableLink(link){
        link.attr("href", link.attr("data-oldhref"));
        link.css("color", link.attr("data-oldcolor"));
    }
    
    function renderTemplate(data){
        if (data){
            $('#panelDiv').html(templateFn(data));
            var a = gPanelIndex+1, 
                b = gPanels.length;
            $('#panelIndex').html(""+(a)+" of "+b);
            if (a==1){
                if (a==b){
                    disableLink($('#prev'));
                    disableLink($('#next'));
                } else {
                    disableLink($('#prev'));
                    enableLink($('#next'));
                }
            } else if (a==b) {
                enableLink($('#prev'));
                disableLink($('#next'));
            } else {
                enableLink($('#prev'));
                enableLink($('#next'));
            }
        }
    }
    
    function getByAuthor(author){
        // AJAX CALL HERE :
       $.get('/anarchia?qtype=author&author='+author,
          function(data) {
              gPanels = data;
              if (data.length && data.length >-1){
                  gPanelIndex = 0;
                  console.log('data: '+JSON.stringify(gPanels));
                  renderTemplate(gPanels[0]);
                  //$('#panelDiv').html(JSON.stringify(gPanels[0]));
              }
          }
       );
    }
    
    function getByStory(storyid){
        // AJAX CALL HERE :
       $.get('/anarchia?qtype=bystory&storyid='+storyid,
          function(data) {
              console.log('getByStory data: '+JSON.stringify(data));
              
              var panelsDict = {};
              data.panels.forEach(function(val, idx, arr){
                   panelsDict[val.id] = val;
              });
              gPanels = [];
              data.story.panels.forEach(function(val, idx, arr){
                  gPanels.push(panelsDict[val]); 
              });
              
              if (gPanels.length && gPanels.length >-1){
                  var imgs = [];
                  for (var i=0; i<gPanels.length; i++) {
                    imgs.push(gPanels[i].img); 
                  }
                  preloadPictures(imgs);
                  gPanelIndex = 0;
                  renderTemplate(gPanels[0]);
                  console.log('panels: '+JSON.stringify(gPanels));
              }
          }
       );
    }
    
    function documentReady(){
        //getByAuthor('laramie');
        if (userStoryID && userStoryID != ''){
            getByStory(userStoryID);
         } else {
            getByStory('http://anarchia.us/id/stories/1');
         }
    }

    $(document).ready(documentReady);
    
    
var preloadPictures = function(pictureUrls, callback) {
    var i,
        j,
        loaded = 0;

    for (i = 0, j = pictureUrls.length; i < j; i++) {
        (function (img, src) {
            img.onload = function () {                               
                if (++loaded == pictureUrls.length && callback) {
                    callback();
                }
            };

            // Use the following callback methods to debug
            // in case of an unexpected behavior.
            img.onerror = function () {};
            img.onabort = function () {};

            img.src = src;
        } (new Image(), pictureUrls[i]));
    }
};


</script>
</html>

